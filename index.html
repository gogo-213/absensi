<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tabel Absensi KJK Dinamis Manual</title>
  <style>
    /* Styling Dasar yang Ditingkatkan */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #eef1f5; }
    h2 { color: #004d99; border-bottom: 3px solid #004d99; padding-bottom: 12px; margin-bottom: 20px; font-size: 1.8em; }
    
    /* Tabel Utama */
    table { 
        border-collapse: collapse; 
        width: 100%; 
        margin-top: 15px; 
        border-radius: 8px; 
        overflow: hidden; 
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); 
        transition: all 0.3s ease; 
        table-layout: fixed; /* Penting untuk presisi kolom */
    }
    table:hover { box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); }

    /* Header Tabel & Sel */
    th, td { 
        border: 1px solid #c9d6de; 
        padding: 8px; 
        text-align: left; 
        transition: background-color 0.2s; 
        font-size: 0.9em; 
        box-sizing: border-box; 
    }
    thead th { 
        background: linear-gradient(135deg, #1e293b, #334155); 
        color: white; 
        cursor: pointer; 
        user-select: none; 
        font-weight: 600;
        letter-spacing: 0.5px;
    }
    thead th:hover { background: linear-gradient(135deg, #334155, #475569); }
    
    /* Baris Data */
    tr:nth-child(even) { background: #f0f4f7; }
    tr:hover:not(:first-child) { background-color: #e2e8f0; }

    /* Input Fields */
    input[type="text"], input[type="file"], select {
      padding: 6px; 
      border: 1px solid #aebac9; 
      border-radius: 6px; 
      box-sizing: border-box;
      background-color: #ffffff;
      font-size: 1em;
      transition: border-color 0.3s, box-shadow 0.3s;
      
      width: 100%; 
      height: 100%; 
      margin: 0;
      
      white-space: nowrap; 
      overflow: hidden;    
      text-overflow: ellipsis; 
    }
    
    input[type="text"]:focus, select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    /* Input Pencarian */
    #search { 
        padding: 10px 15px; 
        width: 300px; 
        margin-bottom: 20px; 
        border: 2px solid #004d99; 
        border-radius: 8px; 
        font-size: 1.1em;
    }
    
    /* Tombol-tombol */
    .export-buttons button, #addRowBtn, #saveBtn {
      padding: 10px 20px; 
      margin-right: 12px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer;
      font-weight: bold; 
      letter-spacing: 0.5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    .export-buttons button { 
        background-color: #0d9488; 
        color: white; 
    }
    .export-buttons button:hover { 
        background-color: #0f766e; 
        transform: translateY(-2px); 
        box-shadow: 0 6px 10px rgba(13, 148, 136, 0.3);
    }
    #addRowBtn { 
        background-color: #3b82f6; 
        color: white; 
    }
    #addRowBtn:hover { 
        background-color: #2563eb; 
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(59, 130, 246, 0.3);
    }
    #saveBtn { 
        background-color: #f59e0b; 
        color: white; 
    }
    #saveBtn:hover { 
        background-color: #d97706; 
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(245, 158, 11, 0.3);
    }

    /* Hasil Input Container */
    .hasil-container {
      margin-top: 30px; 
      padding: 15px; 
      background: #ffffff; 
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .hasil-container h3 { 
        margin-top: 0; 
        padding-bottom: 10px; 
        color: #004d99; 
        border-bottom: 2px solid #e0e7ee;
        font-size: 1.4em;
    }
    .hasil-container table { 
        box-shadow: none; 
        border: none; 
        width: 100%; 
        margin: 10px 0 0; 
    }
    .hasil-container table th, .hasil-container table td { border: 1px solid #e0e7ee; }

    /* Teks Konteks Tanggal */
    #dateSelector label { font-weight: 600; color: #334155; }

    /* Lain-lain */
    .sort-asc::after { content: ' \25B2'; color: #ffd700; }
    .sort-desc::after { content: ' \25BC'; color: #ffd700; }
    
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
        -webkit-appearance: none; margin: 0; 
    }
    input[type=number] { 
        -moz-appearance: textfield;
    }
  </style>
</head>
<body>

<h2>üìù Tabel Absensi / KJK</h2>

<div id="dateSelector" style="margin-bottom: 15px;">
  <label for="monthSelect">Bulan:</label>
  <select id="monthSelect" style="margin-right: 20px;"></select>
  
  <label for="yearSelect">Tahun:</label>
  <select id="yearSelect"></select>
</div>

<input id="search" type="text" placeholder="üîç Cari Nama, NIP, atau Jabatan..." />

<div class="export-buttons">
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="exportExcel()">Export Excel</button>
</div>

<table id="dataTable">
  <colgroup>
    <col style="width:2.0%;">  <col style="width:10.5%;"> <col style="width:6.8%;"> <col style="width:8.0%;"> <col style="width:6%;">  <col style="width:8.3%;"> <col style="width:5.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:4.4%;"> <col style="width:4%;"> <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:4%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:4%;"> <col style="width:6.9%;"> </colgroup>
  <thead>
    <tr>
      <th data-column="no">No</th><th data-column="nama">NAMA</th><th data-column="nip">NIP</th><th data-column="jabatan">Jabatan</th>
      <th data-column="peringkat">Peringkat</th><th data-column="harga_jabatan">Harga Jabatan</th><th data-column="nilai_pres_kerja">Nilai Pres Kerja</th>
      <th data-column="masuk">Masuk</th><th data-column="telat">Telat</th><th data-column="sakit">Sakit</th><th data-column="izin">Izin</th>
      <th data-column="tidak_hadir">Tdk Hadir</th><th data-column="dinas">Dinas</th><th data-column="tugas_luar">Tugas Luar (Onsite)</th>
      <th data-column="tugas_belajar">Tugas Belajar</th><th data-column="cuti">Cuti</th><th data-column="libur">Libur</th>
      <th data-column="jumlah_hk">Jumlah HK</th><th data-column="wk">WK</th><th data-column="tl">TL</th>
      <th data-column="psw">PSW</th><th data-column="total_kjk">TOTAL KJK</th><th data-column="dokumen_pendukung">Dokumen Pendukung</th>
    </tr>
  </thead>
  <tbody>
    <tr class="data-row">
      <td><input type="text" name="no" value="1" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this)" /></td>
      <td><input type="text" name="nama" value="" oninput="updateRowData(this)" /></td>
      <td><input type="text" name="nip" value="" oninput="updateRowData(this)" /></td>
      <td><input type="text" name="jabatan" value="" oninput="updateRowData(this)" /></td>
      <td><input type="text" name="peringkat" value="" oninput="updateRowData(this)" /></td>
      <td><input type="text" name="harga_jabatan" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this)" /></td>
      <td><input type="text" name="nilai_pres_kerja" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this)" /></td>
      <td><input type="text" name="masuk" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="telat" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="sakit" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="izin" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="tidak_hadir" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="dinas" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="tugas_luar" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="tugas_belajar" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="cuti" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="libur" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="jumlah_hk" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="wk" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="tl" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="psw" value="" inputmode="numeric" pattern="[0-9]*" oninput="updateRowData(this);" /></td>
      <td><input type="text" name="total_kjk" value="" oninput="updateRowData(this);" /></td>
      <td><input type="file" name="dokumen_pendukung" onchange="updateRowData(this)" /></td>
    </tr>
  </tbody>
</table>

<br>
<button id="addRowBtn">‚ûï Tambah Baris</button>
<button id="saveBtn">üíæ Simpan Data & Tampilkan Hasil</button>

<div class="hasil-container" id="hasilInputContainer">
  <h3>üìë Tampilan Hasil Input Data</h3>
  <p>Belum ada data yang diinputkan.</p>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        populateDateSelectors(); 
        displayInputResults();

        document.querySelectorAll('#dataTable tbody input').forEach(input => {
             input.oninput = function() { updateRowData(this); };
             if (input.type === 'file') {
                input.onchange = function() { updateRowData(this); };
             }
        });
    });
    
    // --- Fungsi RESET Tabel ---
    function resetTableData() {
        const tbody = document.querySelector('#dataTable tbody');
        const rows = tbody.querySelectorAll('tr');

        // Hapus semua baris kecuali baris pertama (template)
        for (let i = 1; i < rows.length; i++) {
            rows[i].remove();
        }

        // Reset nilai baris pertama (template)
        const firstRow = tbody.querySelector('tr');
        if (firstRow) {
            firstRow.querySelector('input[name="no"]').value = '1';
            firstRow.querySelectorAll('input').forEach(i => {
                if (i.name !== 'no') {
                    i.value = '';
                }
                
                // Reset elemen input file secara paksa
                if (i.type === 'file') {
                    const newFile = document.createElement('input');
                    newFile.type = 'file';
                    newFile.name = i.name;
                    newFile.onchange = function() { updateRowData(this); };
                    i.parentNode.replaceChild(newFile, i);
                }
            });
        }
        
        // Update tampilan setelah reset
        displayInputResults();
    }


    // --- Fungsi Pengisian Dropdown Bulan & Tahun ---
    function populateDateSelectors() {
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const now = new Date();
        const currentMonth = now.getMonth(); 
        const currentYear = now.getFullYear();

        const months = [
            'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
            'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
        ];

        // Isi Bulan (Months)
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index + 1;
            option.textContent = month;
            if (index === currentMonth) {
                option.selected = true;
            }
            monthSelect.appendChild(option);
        });

        // Isi Tahun (Years)
        for (let year = currentYear - 5; year <= currentYear + 5; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) {
                option.selected = true;
            }
            yearSelect.appendChild(option);
        }
        
        // Tambahkan event listener untuk perubahan
        monthSelect.addEventListener('change', updateTableContext);
        yearSelect.addEventListener('change', updateTableContext);
        
        updateTableContext(); // Perbarui konteks awal
    }

    // Fungsi untuk memperbarui konteks tabel (H3 di hasil)
    function updateTableContext() {
        const monthText = document.getElementById('monthSelect').options[document.getElementById('monthSelect').selectedIndex].text;
        const year = document.getElementById('yearSelect').value;
        
        // Perbarui judul di hasil container
        const hasilH3 = document.querySelector('#hasilInputContainer h3');
        if (hasilH3) {
            hasilH3.textContent = `üìë Tampilan Hasil Input Data Bulan ${monthText} Tahun ${year}`;
        }

        // Panggil fungsi reset ketika konteks tanggal berubah
        resetTableData(); 
    }


    function updateRowData(element) {
        displayInputResults();
    }

    function collectData() {
      const rows = document.querySelectorAll('#dataTable tbody tr');
      let data = [];

      rows.forEach(row => {
        if (row.style.display === 'none') return;
        
        let rowData = {};
        row.querySelectorAll('input').forEach(input => {
          if (input.type === 'file') {
             rowData[input.name] = input.files[0]?.name || '';
          } else {
             rowData[input.name] = input.value;
          }
        });
        
        const allEmptyExceptNo = Object.entries(rowData).every(([key, value]) => key === 'no' || value === '');
        if (!allEmptyExceptNo || rows.length === 1) {
            data.push(rowData);
        }
      });
      return data;
    }

    // --- 1. Fungsi Tambah Baris ---
    document.getElementById('addRowBtn').addEventListener('click', function() {
        const tbody = document.querySelector('#dataTable tbody');
        const firstRow = tbody.querySelector('tr');
        if (!firstRow) return;

        const newRow = firstRow.cloneNode(true);
        const newIndex = tbody.children.length + 1;
        newRow.querySelector('input[name="no"]').value = newIndex;
        newRow.querySelectorAll('input').forEach(i => {
            if (i.name !== 'no') i.value = '';
            
            if (i.type === 'file') {
                const newFile = document.createElement('input');
                newFile.type = 'file';
                newFile.name = i.name;
                newFile.onchange = function() { updateRowData(this); };
                i.parentNode.replaceChild(newFile, i);
            } else {
                 i.oninput = function() { updateRowData(this); };
            }
        });
        
        tbody.appendChild(newRow);
        newRow.querySelector('input[name="nama"]').focus();
        displayInputResults();
    });

    // --- 2. Fungsi Pencarian/Filter ---
    document.getElementById('search').addEventListener('keyup', function() {
        const filter = this.value.toUpperCase();
        const rows = document.querySelectorAll('#dataTable tbody tr');

        rows.forEach(row => {
            const nama = row.querySelector('input[name="nama"]').value.toUpperCase();
            const nip = row.querySelector('input[name="nip"]').value.toUpperCase();
            const jabatan = row.querySelector('input[name="jabatan"]').value.toUpperCase();
            
            if (nama.includes(filter) || nip.includes(filter) || jabatan.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        displayInputResults(); 
    });

    // --- 3. Fungsi Pengurutan (Sorting) ---
    const headers = document.querySelectorAll('#dataTable thead th[data-column]');
    let sortColumn = null;
    let sortDirection = 'asc';

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            headers.forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            this.classList.add('sort-' + sortDirection);

            sortData(column, sortDirection);
            displayInputResults();
        });
    });

    function sortData(column, direction) {
        const tbody = document.querySelector('#dataTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        const sortedRows = rows.sort((a, b) => {
            let aValue, bValue;

            const aInput = a.querySelector(`input[name="${column}"]`);
            const bInput = b.querySelector(`input[name="${column}"]`);

            if (aInput && bInput) {
                if (['no', 'harga_jabatan', 'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir', 'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk', 'wk', 'tl', 'psw', 'total_kjk'].includes(column)) {
                    aValue = Number(aInput.value.replace(/[^0-9\.]/g, '')) || 0;
                    bValue = Number(bInput.value.replace(/[^0-9\.]/g, '')) || 0;
                } else {
                    aValue = aInput.value.toLowerCase();
                    bValue = bInput.value.toLowerCase();
                }
            } else {
                return 0;
            }

            let comparison = 0;
            if (aValue > bValue) {
                comparison = 1;
            } else if (aValue < bValue) {
                comparison = -1;
            }

            return direction === 'asc' ? comparison : comparison * -1;
        });

        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
    }


    // --- 4. Fungsi Tampilan Hasil Input Data ---
    function displayInputResults() {
        const data = collectData();
        const resultBox = document.getElementById('hasilInputContainer');
        const monthText = document.getElementById('monthSelect')?.options[document.getElementById('monthSelect').selectedIndex].text || "Bulan";
        const year = document.getElementById('yearSelect')?.value || "Tahun";


        if (data.length === 0 || (data.length === 1 && Object.values(data[0]).every(v => v === '' || (v === '1' && Object.keys(data[0]).includes('no'))))) {
             resultBox.innerHTML = `<h3>üìë Tampilan Hasil Input Data Bulan ${monthText} Tahun ${year}</h3><p>Belum ada data yang diinputkan.</p>`;
            return;
        }

        let html = `<h3>üìë Tampilan Hasil Input Data Bulan ${monthText} Tahun ${year}</h3>`;
        
        html += '<table id="resultTable">';
        
        // --- Copy COLGROUP dari tabel input untuk presisi ---
        const colgroup = document.querySelector('#dataTable colgroup').outerHTML;
        html += colgroup;
        // --- END Copy COLGROUP ---

        const headerRow = document.querySelector('#dataTable thead tr').outerHTML;
        html += '<thead>' + headerRow + '</thead>';
        
        html += '<tbody>';
        
        const fields = [
            'no', 'nama', 'nip', 'jabatan', 'peringkat', 'harga_jabatan', 
            'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir', 
            'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk', 
            'wk', 'tl', 'psw', 'total_kjk', 'dokumen_pendukung'
        ];

        data.forEach(r => {
            const isBlankRow = fields.every(field => r[field] === '' || (field === 'no' && r[field] === '1'));
            if (isBlankRow && data.length > 1) {
                return;
            }

            html += '<tr>';
            fields.forEach(field => {
                let value = r[field] !== undefined ? r[field] : '';
                
                // --- MODIFIKASI DOKUMEN PENDUKUNG ---
                if (field === 'dokumen_pendukung') {
                    if (value && value !== 'No chosen file') { 
                        value = '‚úÖ Ada Dokumen';
                    } else {
                        value = '‚ùå Tidak Ada';
                    }
                }
                // --- AKHIR MODIFIKASI ---

                html += `<td>${value}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        
        resultBox.innerHTML = html;
    }
    
    document.getElementById('saveBtn').addEventListener('click', function() {
        displayInputResults();
        alert('Data berhasil disimpan dan ditampilkan di bawah tabel input.');
    });


    // --- 5. Fungsi Export CSV/Excel ---
    function exportTo(type) {
        const monthText = document.getElementById('monthSelect')?.options[document.getElementById('monthSelect').selectedIndex].text || "Bulan";
        const year = document.getElementById('yearSelect')?.value || "Tahun";
        const table = document.getElementById('dataTable');
        const rows = table.querySelectorAll('tr');
        let csvContent = '';

        const headerCells = table.querySelectorAll('thead th');
        const headerText = Array.from(headerCells).map(th => `"${th.textContent.trim().replace(/\s+/g, ' ')}"`).join(';');
        csvContent += headerText + '\n';

        rows.forEach((row, rowIndex) => {
            if (rowIndex === 0) return;
            
            const rowData = [];
            const inputs = row.querySelectorAll('input');
            
            inputs.forEach(input => {
                let value = input.value;
                if (input.type === 'file') {
                    value = input.files[0]?.name || '';
                } else if (['total_kjk', 'harga_jabatan'].includes(input.name)) {
                    value = input.value.replace(/[^0-9\.]/g, '');
                }
                rowData.push(`"${value.replace(/"/g, '""')}"`);
            });
            csvContent += rowData.join(';') + '\n';
        });

        const filename = `Tabel_Absensi_KJK_${monthText}_${year}_${new Date().toISOString().slice(0, 10)}`;
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename + (type === 'Excel' ? '.xls' : '.csv')); 
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert('Browser Anda tidak mendukung pengunduhan file secara otomatis.');
        }
    }

    function exportCSV() {
        exportTo('CSV');
    }

    function exportExcel() {
        exportTo('Excel');
    }
</script>

</body>
</html>
