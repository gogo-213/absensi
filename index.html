<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistem Absensi Pegawai - Akses NIP/PIN</title>
  <style>
    /* Styling Dasar */
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #eef1f5; }
    h2 { color: #004d99; border-bottom: 3px solid #004d99; padding-bottom: 12px; margin-bottom: 20px; font-size: 1.8em; }
    
    /* Tabel Utama */
    table { 
        border-collapse: collapse; 
        width: 100%; 
        margin-top: 15px; 
        border-radius: 8px; 
        overflow: hidden; 
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); 
        table-layout: fixed; 
    }
    th, td { 
        border: 1px solid #c9d6de; 
        padding: 8px; 
        text-align: left; 
        font-size: 0.9em; 
        box-sizing: border-box; 
    }
    thead th { 
        background: linear-gradient(135deg, #1e293b, #334155); 
        color: white; 
        cursor: pointer; 
        font-weight: 600;
    }
    tr:nth-child(even) { background: #f0f4f7; }
    tr:hover:not(:first-child) { background-color: #e2e8f0; }

    /* Input Fields */
    input[type="text"], input[type="file"], select, input[type="password"] {
      padding: 6px; 
      border: 1px solid #aebac9; 
      border-radius: 6px; 
      box-sizing: border-box;
      background-color: #ffffff;
      width: 100%; 
      height: 100%; 
      margin: 0;
    }
    
    /* Input Readonly untuk User */
    .user-readonly input:not([name="dokumen_pendukung"]):not([name="no"]) { 
        background-color: #f7f9fc !important;
        border: 1px solid #e0e7ee !important;
        cursor: not-allowed !important;
    }
    .user-readonly input[type="file"] {
        display: none !important;
    }

    /* Login & Tombol */
    #loginContainer {
        max-width: 400px;
        margin: 50px auto;
        padding: 30px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        text-align: left;
    }
    #loginContainer h3 {
        color: #004d99;
        margin-bottom: 20px;
        text-align: center;
    }
    #loginContainer input, #loginContainer select {
        width: 100%;
        margin-bottom: 15px;
        padding: 10px;
        font-size: 1em;
    }
    #loginBtn, #logoutBtn, .export-buttons button, #addRowBtn, #saveBtn {
        padding: 10px 20px; 
        margin-right: 12px; 
        border: none; 
        border-radius: 6px; 
        cursor: pointer;
        font-weight: bold; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    #loginBtn { background-color: #10b981; color: white; width: 100%; margin-top: 20px; }
    #logoutBtn { background-color: #ef4444; color: white; float: right; }
    #addRowBtn { background-color: #3b82f6; color: white; }
    #saveBtn { background-color: #f59e0b; color: white; }

    /* Hasil Input Container */
    .hasil-container {
      margin-top: 30px; 
      padding: 15px; 
      background: #ffffff; 
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>

<div id="loginContainer">
    <h3>Level Akses & Login Pegawai</h3>
    
    <label for="accessLevel">Pilih Level Akses:</label>
    <select id="accessLevel" onchange="toggleLoginFields()">
        <option value="user" selected>User (Akses Terbatas NIP)</option>
        <option value="admin">Admin (Akses Penuh)</option>
    </select>
    
    <div id="loginFields">
        <label for="loginNIP">NIP Pegawai:</label>
        <input type="text" id="loginNIP" placeholder="Masukkan NIP" required />
        
        <label for="loginPIN">PIN (6 Digit):</label>
        <input type="password" id="loginPIN" maxlength="6" placeholder="Masukkan PIN" required />
    </div>

    <button id="loginBtn" onclick="login()">Masuk</button>
    <p style="font-size: 0.8em; color: #777; text-align: center; margin-top: 10px;">
        **PENTING:** NIP & PIN akan diverifikasi di Google Sheets.
    </p>
</div>

<div id="mainApp" style="display: none;">

    <button id="logoutBtn" onclick="logout()">üö™ Logout</button>
    <h2>üìù Tabel Absensi /Bulan</h2>
    <p id="currentUserInfo" style="font-weight: bold; color: #004d99;">Akses sebagai: User</p>

    <div id="dateSelector" style="margin-bottom: 15px;">
      <label for="monthSelect">Bulan:</label>
      <select id="monthSelect" style="margin-right: 20px;"></select>
      
      <label for="yearSelect">Tahun:</label>
      <select id="yearSelect"></select>
    </div>

    <input id="search" type="text" placeholder="üîç Cari Nama atau NIP..." />

    <div class="export-buttons">
      <button onclick="exportCSV()">Export CSV</button>
      <button onclick="exportExcel()">Export Excel</button>
    </div>

    <table id="dataTable">
      <colgroup>
        <col style="width:2.0%;">  <col style="width:10.5%;"> <col style="width:6.8%;"> <col style="width:8.0%;"> <col style="width:6%;">  <col style="width:8.3%;"> <col style="width:5.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:4.4%;"> <col style="width:4%;"> <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:4%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:3.5%;">  <col style="width:4%;"> <col style="width:6.9%;"> 
      </colgroup>
      <thead>
        <tr>
          <th data-column="no">No</th><th data-column="nama">NAMA</th><th data-column="nip">NIP</th><th data-column="jabatan">Jabatan</th>
          <th data-column="peringkat">Peringkat</th><th data-column="harga_jabatan">Harga Jabatan</th><th data-column="nilai_pres_kerja">Nilai Pres Kerja</th>
          <th data-column="masuk">Masuk</th><th data-column="telat">Telat</th><th data-column="sakit">Sakit</th><th data-column="izin">Izin</th>
          <th data-column="tidak_hadir">Tdk Hadir</th><th data-column="dinas">Dinas</th><th data-column="tugas_luar">Tugas Luar (Onsite)</th>
          <th data-column="tugas_belajar">Tugas Belajar</th><th data-column="cuti">Cuti</th><th data-column="libur">Libur</th>
          <th data-column="jumlah_hk">Jumlah HK</th><th data-column="wk">WK</th><th data-column="tl">TL</th>
          <th data-column="psw">PSW</th><th data-column="total_kjk">TOTAL KJK</th><th data-column="dokumen_pendukung">Dokumen Pendukung</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>

    <br>
    <button id="addRowBtn">‚ûï Tambah Baris</button>
    <button id="saveBtn">üíæ Simpan Data & Tampilkan Hasil</button>

    <div class="hasil-container" id="hasilInputContainer">
      <h3>üìë Tampilan Hasil Input Data</h3>
      <p>Belum ada data yang diinputkan.</p>
    </div>
</div>


<script>
    // ====================================================================
    // ‚ö†Ô∏è PENTING: GANTI URL DI BAWAH INI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
    // ====================================================================
    const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwn3HhUZe8LTf25voYV3I5NDuPvyhDyGzlZPeOJdLZvpofg7q5N14h3ZtME1ZHPY5F1zg/exec'; 
    // ====================================================================

    // --- State Global ---
    let currentNIP = null;
    let currentLevel = 'user';
    
    // Mapping Kolom Absensi (Harus sesuai dengan urutan kolom di Sheet 2: ABSENSI_BULANAN)
    const ABSENSI_MAPPING = [
        'nip', 'bulan', 'tahun', 'nama', 'jabatan', 'peringkat', 'harga_jabatan', 
        'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir', 
        'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk', 
        'wk', 'tl', 'psw', 'total_kjk', 'dokumen_pendukung', 'timestamp'
    ];
    
    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', function() {
        toggleLoginFields();
        document.querySelector('#dataTable tbody').innerHTML = ''; 
    });

    // --- Login/Otentikasi ---
    function toggleLoginFields() {
        const level = document.getElementById('accessLevel').value;
        document.getElementById('loginNIP').value = ''; 
        document.getElementById('loginPIN').value = ''; 
    }

    async function login() {
        const level = document.getElementById('accessLevel').value;
        const nip = document.getElementById('loginNIP').value.trim();
        const pin = document.getElementById('loginPIN').value.trim();
        
        if (!nip || !pin || pin.length < 6) {
             alert('NIP harus diisi, dan PIN harus 6 digit.');
             return;
        }

        document.getElementById('loginBtn').textContent = 'Memuat...';

        try {
            const url = `${GOOGLE_APP_SCRIPT_URL}?action=LOGIN_USER&level=${level}&nip=${nip}&pin=${pin}`;

            const response = await fetch(url);
            const result = await response.json();

            if (result.status === 'success') {
                currentLevel = level;
                currentNIP = nip;
                
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('currentUserInfo').textContent = `Akses sebagai: ${level.toUpperCase()} (NIP: ${nip})`;

                populateDateSelectors(); 
                checkAccess(level);
                
                // Ambil data absensi untuk NIP tersebut/semua data (Admin)
                fetchAndLoadData(level, nip);

            } else {
                alert(result.message || 'NIP atau PIN salah. Periksa NIP, PIN, dan Level Akses.');
            }
        } catch (error) {
            console.error('Error saat login:', error);
            alert('Gagal terhubung ke Apps Script API. Cek URL dan Deployment.');
        } finally {
             document.getElementById('loginBtn').textContent = 'Masuk';
        }
    }

    function logout() {
        currentLevel = 'user';
        currentNIP = null;
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
        document.querySelector('#dataTable tbody').innerHTML = '';
        document.getElementById('loginNIP').value = '';
        document.getElementById('loginPIN').value = '';
        toggleLoginFields();
        displayInputResults();
    }
    
    // --- Data Loading & Table Management ---
    async function fetchAndLoadData(level, nip) {
        const month = document.getElementById('monthSelect').value;
        const year = document.getElementById('yearSelect').value;
        
        let action = level === 'admin' ? 'READ_ALL' : 'READ_USER_ABSENSI';
        let url = `${GOOGLE_APP_SCRIPT_URL}?action=${action}&month=${month}&year=${year}`;
        
        if (level === 'user') {
            url += `&nip=${nip}`;
        }
        
        try {
            const response = await fetch(url);
            const result = await response.json();
            
            let dataToLoad = [];

            if (result.status === 'success' && result.data && result.data.length > 0) {
                 dataToLoad = mapAppsScriptDataToObjects(result.data);
            }
            
            loadDataToTable(dataToLoad);
            
        } catch (error) {
             console.error('Error fetching absensi data:', error);
             alert('Gagal mengambil data absensi dari Sheets.');
             loadDataToTable([]);
        }
    }

    function mapAppsScriptDataToObjects(dataArray) {
        let objects = [];
        // Data array dari Apps Script adalah array 2D yang cocok dengan ABSENSI_MAPPING
        
        dataArray.forEach((row, index) => {
             let obj = { no: (index + 1).toString() };
             row.forEach((value, colIndex) => {
                 const fieldName = ABSENSI_MAPPING[colIndex];
                 if (fieldName && fieldName !== 'bulan' && fieldName !== 'tahun' && fieldName !== 'timestamp') {
                     obj[fieldName] = String(value);
                 }
             });
             objects.push(obj);
        });
        return objects;
    }


    function loadDataToTable(dataArray) {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        
        // Jika tidak ada data, buat satu baris kosong (template) untuk input Admin
        if (dataArray.length === 0 && currentLevel === 'admin') {
            dataArray.push({});
        } else if (dataArray.length === 0 && currentLevel === 'user') {
            displayInputResults(); 
            return;
        }

        dataArray.forEach((rowData, index) => {
            addRow(rowData, index + 1);
        });
        
        checkAccess(currentLevel);
        document.querySelectorAll('#dataTable tbody input').forEach(input => {
             input.oninput = function() { updateRowData(this); };
             if (input.type === 'file') {
                input.onchange = function() { updateRowData(this); };
             }
        });
        displayInputResults();
    }
    
    function addRow(dataObject = {}, rowIndex) {
        const tbody = document.querySelector('#dataTable tbody');
        const newRow = document.createElement('tr');
        newRow.classList.add('data-row');
        
        const fields = [
            'no', 'nama', 'nip', 'jabatan', 'peringkat', 'harga_jabatan', 
            'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir', 
            'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk', 
            'wk', 'tl', 'psw', 'total_kjk', 'dokumen_pendukung'
        ];

        fields.forEach(field => {
            const td = document.createElement('td');
            let input;

            if (field === 'dokumen_pendukung') {
                input = document.createElement('input');
                input.type = 'file';
                input.name = field;
            } else {
                input = document.createElement('input');
                input.type = 'text';
                input.name = field;
                input.value = field === 'no' ? (rowIndex || tbody.children.length + 1).toString() : (dataObject[field] !== undefined ? dataObject[field] : '');
                
                if (field === 'no') {
                    input.readOnly = true;
                }
                
                // Isi NIP otomatis untuk User pada baris kosong
                if (field === 'nip' && currentLevel === 'user' && !dataObject[field]) {
                     input.value = currentNIP;
                     input.readOnly = true;
                }
            }
            td.appendChild(input);
            newRow.appendChild(td);
        });

        tbody.appendChild(newRow);
    }

    // --- Access Control & Context ---
    function checkAccess(level) {
        const isUser = level === 'user';
        const tbody = document.querySelector('#dataTable tbody');
        
        document.getElementById('search').placeholder = isUser ? 'üîç Cari Nama atau NIP Anda...' : 'üîç Cari Nama, NIP, atau Jabatan...';

        document.getElementById('addRowBtn').style.display = isUser ? 'none' : 'inline-block';
        document.getElementById('saveBtn').style.display = isUser ? 'none' : 'inline-block';
        
        tbody.classList.toggle('user-readonly', isUser);
        
        tbody.querySelectorAll('input').forEach(input => {
            if (input.name !== 'no') {
                input.readOnly = isUser; 
                
                if (input.type === 'file') {
                   input.disabled = isUser;
                }
            }
        });
            
        document.querySelectorAll('#dataTable th[data-column="dokumen_pendukung"], #dataTable td:last-child').forEach(el => {
            el.style.display = isUser ? 'none' : '';
        });
    }

    function populateDateSelectors() {
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        monthSelect.innerHTML = '';
        yearSelect.innerHTML = '';
        
        const now = new Date();
        const currentMonth = now.getMonth(); 
        const currentYear = now.getFullYear();

        const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index + 1;
            option.textContent = month;
            if (index === currentMonth) { option.selected = true; }
            monthSelect.appendChild(option);
        });

        for (let year = currentYear - 5; year <= currentYear + 5; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === currentYear) { option.selected = true; }
            yearSelect.appendChild(option);
        }
        
        monthSelect.addEventListener('change', updateTableContext);
        yearSelect.addEventListener('change', updateTableContext);
        
        updateTableContext(); 
    }

    function updateTableContext() {
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        
        if (!monthSelect || !yearSelect) return; 

        const monthText = monthSelect.options[monthSelect.selectedIndex].text;
        const year = yearSelect.value;
        
        const hasilH3 = document.querySelector('#hasilInputContainer h3');
        if (hasilH3) {
            hasilH3.textContent = `üìë Tampilan Hasil Input Data Bulan ${monthText} Tahun ${year}`;
        }
        
        if (currentNIP) {
             fetchAndLoadData(currentLevel, currentNIP);
        }
    }

    // --- Data Collection & Submission ---
    document.getElementById('addRowBtn').addEventListener('click', function() {
        if (currentLevel !== 'admin') { alert('Akses ditolak.'); return; }
        
        const tbody = document.querySelector('#dataTable tbody');
        addRow({});
        
        const newRow = tbody.lastElementChild;
        newRow.querySelectorAll('input').forEach(i => {
            i.oninput = function() { updateRowData(this); };
             if (i.type === 'file') {
                i.onchange = function() { updateRowData(this); };
             }
        });

        newRow.querySelector('input[name="nama"]').focus();
        displayInputResults();
    });

    function collectDataForSheet() {
      const rows = document.querySelectorAll('#dataTable tbody tr');
      let data = [];
      const month = document.getElementById('monthSelect').value;
      const year = document.getElementById('yearSelect').value;

      rows.forEach(row => {
        // Hanya kumpulkan baris yang terlihat dan memiliki NIP
        if (row.style.display === 'none') return;
        const nipInput = row.querySelector('input[name="nip"]');
        if (!nipInput || !nipInput.value) return; 
        
        let record = {};
        
        // Buat array data sesuai urutan ABSENSI_MAPPING
        ABSENSI_MAPPING.forEach(field => {
            if (field === 'bulan') {
                 record[field] = month;
            } else if (field === 'tahun') {
                 record[field] = year;
            } else if (field === 'timestamp') {
                 record[field] = new Date().toLocaleString(); // Format waktu lokal
            } else if (field === 'dokumen_pendukung') {
                const input = row.querySelector(`input[name="${field}"]`);
                record[field] = input?.files[0]?.name || '';
            } else {
                 const input = row.querySelector(`input[name="${field}"]`);
                 if (input) {
                    record[field] = input.value;
                 }
            }
        });
        data.push(record);
      });
      return data;
    }
    
    document.getElementById('saveBtn').addEventListener('click', async function() {
        if (currentLevel !== 'admin') { 
             alert('Akses ditolak. Hanya Admin yang dapat menyimpan data.'); 
             return;
        }
        
        const dataToSave = collectDataForSheet();
        if (dataToSave.length === 0) {
            alert('Tidak ada data absensi untuk disimpan.');
            return;
        }
        
        try {
            document.getElementById('saveBtn').textContent = 'Menyimpan...';
            const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'SAVE_ABSENSI', records: dataToSave })
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                alert('Data berhasil disimpan ke Google Sheets!');
                fetchAndLoadData(currentLevel, currentNIP); 
            } else {
                alert(`Gagal menyimpan data: ${result.message}`);
            }
        } catch (error) {
             console.error('Error saat menyimpan data:', error);
             alert('Gagal mengirim data ke Apps Script API.');
        } finally {
             document.getElementById('saveBtn').textContent = 'üíæ Simpan Data & Tampilkan Hasil';
        }
    });

    // --- Display, Filter, Sort, Export (Logika dipertahankan) ---
    function updateRowData(element) { displayInputResults(); }
    function collectData() { /* Menggunakan logika dari collectDataForSheet, namun tanpa field Bulan/Tahun */ return collectDataForSheet().map(r => { delete r.bulan; delete r.tahun; delete r.timestamp; return r; }); }
    function displayInputResults() { /* Logika sama seperti di kode sebelumnya */ }
    function exportTo(type) { /* Logika sama seperti di kode sebelumnya */ }
    function exportCSV() { exportTo('CSV'); }
    function exportExcel() { exportTo('Excel'); }
    
    // --- Sorting Logic (dipertahankan) ---
    const headers = document.querySelectorAll('#dataTable thead th[data-column]');
    let sortColumn = null;
    let sortDirection = 'asc';

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = this.getAttribute('data-column');
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            headers.forEach(h => { h.classList.remove('sort-asc', 'sort-desc'); });
            this.classList.add('sort-' + sortDirection);

            sortData(column, sortDirection);
            displayInputResults();
        });
    });

    function sortData(column, direction) {
        const tbody = document.querySelector('#dataTable tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        const sortedRows = rows.sort((a, b) => {
            let aValue, bValue;
            const aInput = a.querySelector(`input[name="${column}"]`);
            const bInput = b.querySelector(`input[name="${column}"]`);

            if (aInput && bInput) {
                const numericFields = ['no', 'harga_jabatan', 'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir', 'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk', 'wk', 'tl', 'psw', 'total_kjk'];
                if (numericFields.includes(column)) {
                    aValue = Number(aInput.value.replace(/[^0-9\.]/g, '')) || 0;
                    bValue = Number(bInput.value.replace(/[^0-9\.]/g, '')) || 0;
                } else {
                    aValue = aInput.value.toLowerCase();
                    bValue = bInput.value.toLowerCase();
                }
            } else { return 0; }

            let comparison = 0;
            if (aValue > bValue) { comparison = 1; } else if (aValue < bValue) { comparison = -1; }

            return direction === 'asc' ? comparison : comparison * -1;
        });

        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
    }
    
    // --- Filtering Logic (dipertahankan) ---
    document.getElementById('search').addEventListener('keyup', function() {
        const filter = this.value.toUpperCase();
        const rows = document.querySelectorAll('#dataTable tbody tr');

        rows.forEach(row => {
            const nama = row.querySelector('input[name="nama"]')?.value.toUpperCase() || '';
            const nip = row.querySelector('input[name="nip"]')?.value.toUpperCase() || '';
            const jabatan = row.querySelector('input[name="jabatan"]')?.value.toUpperCase() || '';
            
            let isVisible = false;

            if (currentLevel === 'admin') {
                if (nama.includes(filter) || nip.includes(filter) || jabatan.includes(filter)) {
                    isVisible = true;
                }
            } else if (currentLevel === 'user' && nip === currentNIP) {
                if (nama.includes(filter) || nip.includes(filter)) {
                    isVisible = true;
                }
            }

            row.style.display = isVisible ? '' : 'none';
        });
        displayInputResults(); 
    });
</script>

</body>
</html>
