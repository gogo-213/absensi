<!doctype html>
<html lang="id">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Sistem Absensi Pegawai - Akses NIP/PIN</title>
Â  <style>
Â  Â  /* Styling Dasar */
Â  Â  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #eef1f5; }
Â  Â  h2 { color: #004d99; border-bottom: 3px solid #004d99; padding-bottom: 12px; margin-bottom: 20px; font-size: 1.8em; }
Â  Â Â 
Â  Â  /* Tabel Utama */
Â  Â  table {Â 
Â  Â  Â  Â  border-collapse: collapse;Â 
Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  margin-top: 15px;Â 
Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);Â 
Â  Â  Â  Â  table-layout: fixed;Â 
Â  Â  }
Â  Â  th, td {Â 
Â  Â  Â  Â  border: 1px solid #c9d6de;Â 
Â  Â  Â  Â  padding: 8px;Â 
Â  Â  Â  Â  text-align: left;Â 
Â  Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  }
Â  Â  thead th {Â 
Â  Â  Â  Â  background: linear-gradient(135deg, #1e293b, #334155);Â 
Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  tr:nth-child(even) { background: #f0f4f7; }
Â  Â  tr:hover:not(:first-child) { background-color: #e2e8f0; }

Â  Â  /* Input Fields */
Â  Â  input[type="text"], input[type="file"], select, input[type="password"] {
Â  Â  Â  padding: 6px;Â 
Â  Â  Â  border: 1px solid #aebac9;Â 
Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  box-sizing: border-box;
Â  Â  Â  background-color: #ffffff;
Â  Â  Â  width: 100%;Â 
Â  Â  Â  height: 100%;Â 
Â  Â  Â  margin: 0;
Â  Â  }
Â  Â Â 
Â  Â  /* Input Readonly untuk User */
Â  Â  .user-readonly input:not([name="dokumen_pendukung"]):not([name="no"]) {Â 
Â  Â  Â  Â  background-color: #f7f9fc !important;
Â  Â  Â  Â  border: 1px solid #e0e7ee !important;
Â  Â  Â  Â  cursor: not-allowed !important;
Â  Â  }
Â  Â  .user-readonly input[type="file"] {
Â  Â  Â  Â  display: none !important;
Â  Â  }

Â  Â  /* Login & Tombol */
Â  Â  #loginContainer {
Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  margin: 50px auto;
Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  background: white;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  text-align: left;
Â  Â  }
Â  Â  #loginContainer h3 {
Â  Â  Â  Â  color: #004d99;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  #loginContainer input, #loginContainer select {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  font-size: 1em;
Â  Â  }
Â  Â  #loginBtn, #logoutBtn, .export-buttons button, #addRowBtn, #saveBtn {
Â  Â  Â  Â  padding: 10px 20px;Â 
Â  Â  Â  Â  margin-right: 12px;Â 
Â  Â  Â  Â  border: none;Â 
Â  Â  Â  Â  border-radius: 6px;Â 
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
Â  Â  }
Â  Â  #loginBtn { background-color: #10b981; color: white; width: 100%; margin-top: 20px; }
Â  Â  #logoutBtn { background-color: #ef4444; color: white; float: right; }
Â  Â  #addRowBtn { background-color: #3b82f6; color: white; }
Â  Â  #saveBtn { background-color: #f59e0b; color: white; }

Â  Â  /* Hasil Input Container */
Â  Â  .hasil-container {
Â  Â  Â  margin-top: 30px;Â 
Â  Â  Â  padding: 15px;Â 
Â  Â  Â  background: #ffffff;Â 
Â  Â  Â  border-radius: 10px;
Â  Â  Â  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
Â  Â  }
Â  </style>
</head>
<body>

<div id="loginContainer">
Â  Â  <h3>Level Akses & Login Pegawai</h3>
Â  Â Â 
Â  Â  <label for="accessLevel">Pilih Level Akses:</label>
Â  Â  <select id="accessLevel" onchange="toggleLoginFields()">
Â  Â  Â  Â  <option value="user" selected>User (Akses Terbatas NIP)</option>
Â  Â  Â  Â  <option value="admin">Admin (Akses Penuh)</option>
Â  Â  </select>
Â  Â Â 
Â  Â  <div id="loginFields">
Â  Â  Â  Â  <label for="loginNIP">NIP Pegawai:</label>
Â  Â  Â  Â  <input type="text" id="loginNIP" placeholder="Masukkan NIP" required />
Â  Â  Â  Â Â 
Â  Â  Â  Â  <label for="loginPIN">PIN (6 Digit):</label>
Â  Â  Â  Â  <input type="password" id="loginPIN" maxlength="6" placeholder="Masukkan PIN" required />
Â  Â  </div>

Â  Â  <button id="loginBtn" onclick="login()">Masuk</button>
Â  Â  <p style="font-size: 0.8em; color: #777; text-align: center; margin-top: 10px;">
Â  Â  Â  Â  **PENTING:** NIP & PIN akan diverifikasi di Google Sheets.
Â  Â  </p>
</div>

<div id="mainApp" style="display: none;">

Â  Â  <button id="logoutBtn" onclick="logout()">ğŸšª Logout</button>
Â  Â  <h2>ğŸ“ Tabel Absensi /Bulan</h2>
Â  Â  <p id="currentUserInfo" style="font-weight: bold; color: #004d99;">Akses sebagai: User</p>

Â  Â  <div id="dateSelector" style="margin-bottom: 15px;">
Â  Â  Â  <label for="monthSelect">Bulan:</label>
Â  Â  Â  <select id="monthSelect" style="margin-right: 20px;"></select>
Â  Â  Â Â 
Â  Â  Â  <label for="yearSelect">Tahun:</label>
Â  Â  Â  <select id="yearSelect"></select>
Â  Â  </div>

Â  Â  <input id="search" type="text" placeholder="ğŸ” Cari Nama atau NIP..." />

Â  Â  <div class="export-buttons">
Â  Â  Â  <button onclick="exportCSV()">Export CSV</button>
Â  Â  Â  <button onclick="exportExcel()">Export Excel</button>
Â  Â  </div>

Â  Â  <table id="dataTable">
Â  Â  Â  <colgroup>
Â  Â  Â  Â  <col style="width:2.0%;">Â  <col style="width:10.5%;"> <col style="width:6.8%;"> <col style="width:8.0%;"> <col style="width:6%;">Â  <col style="width:8.3%;"> <col style="width:5.5%;">Â  <col style="width:3.5%;">Â  <col style="width:3.5%;">Â  <col style="width:3.5%;">Â  <col style="width:3.5%;">Â  <col style="width:3.5%;">Â  <col style="width:3.5%;">Â  <col style="width:4.4%;"> <col style="width:4%;"> <col style="width:3.5%;">Â  <col style="width:3.5%;">Â  <col style="width:4%;">Â  <col style="width:3.5%;">Â  <col style="width:3.5%;">Â  <col style="width:3.5%;">Â  <col style="width:4%;"> <col style="width:6.9%;">Â 
Â  Â  Â  </colgroup>
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th data-column="no">No</th><th data-column="nama">NAMA</th><th data-column="nip">NIP</th><th data-column="jabatan">Jabatan</th>
Â  Â  Â  Â  Â  <th data-column="peringkat">Peringkat</th><th data-column="harga_jabatan">Harga Jabatan</th><th data-column="nilai_pres_kerja">Nilai Pres Kerja</th>
Â  Â  Â  Â  Â  <th data-column="masuk">Masuk</th><th data-column="telat">Telat</th><th data-column="sakit">Sakit</th><th data-column="izin">Izin</th>
Â  Â  Â  Â  Â  <th data-column="tidak_hadir">Tdk Hadir</th><th data-column="dinas">Dinas</th><th data-column="tugas_luar">Tugas Luar (Onsite)</th>
Â  Â  Â  Â  Â  <th data-column="tugas_belajar">Tugas Belajar</th><th data-column="cuti">Cuti</th><th data-column="libur">Libur</th>
Â  Â  Â  Â  Â  <th data-column="jumlah_hk">Jumlah HK</th><th data-column="wk">WK</th><th data-column="tl">TL</th>
Â  Â  Â  Â  Â  <th data-column="psw">PSW</th><th data-column="total_kjk">TOTAL KJK</th><th data-column="dokumen_pendukung">Dokumen Pendukung</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody>
Â  Â  Â  Â  </tbody>
Â  Â  </table>

Â  Â  <br>
Â  Â  <button id="addRowBtn">â• Tambah Baris</button>
Â  Â  <button id="saveBtn">ğŸ’¾ Simpan Data & Tampilkan Hasil</button>

Â  Â  <div class="hasil-container" id="hasilInputContainer">
Â  Â  Â  <h3>ğŸ“‘ Tampilan Hasil Input Data</h3>
Â  Â  Â  <p>Belum ada data yang diinputkan.</p>
Â  Â  </div>
</div>


<script>
Â  Â  // ====================================================================
Â  Â  // âš ï¸ PENTING: GANTI URL DI BAWAH INI DENGAN URL WEB APP GOOGLE APPS SCRIPT ANDA
Â  Â  // ====================================================================
Â  Â  const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzxLUxNJqAfclPFq-fUVm6ZVn3HURSOV8DyDwYF8uQhem7Ba7QCo9HuXx-SupW--Fqm9Q/exec';Â 
Â  Â  // ====================================================================

Â  Â  // --- State Global ---
Â  Â  let currentNIP = null;
Â  Â  let currentLevel = 'user';
Â  Â Â 
Â  Â  // Mapping Kolom Absensi (Harus sesuai dengan urutan kolom di Sheet 2: ABSENSI_BULANAN)
Â  Â  const ABSENSI_MAPPING = [
Â  Â  Â  Â  'nip', 'bulan', 'tahun', 'nama', 'jabatan', 'peringkat', 'harga_jabatan',Â 
Â  Â  Â  Â  'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir',Â 
Â  Â  Â  Â  'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk',Â 
Â  Â  Â  Â  'wk', 'tl', 'psw', 'total_kjk', 'dokumen_pendukung', 'timestamp'
Â  Â  ];
Â  Â Â 
Â  Â  // --- Initial Load ---
Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  toggleLoginFields();
Â  Â  Â  Â  document.querySelector('#dataTable tbody').innerHTML = '';Â 
Â  Â  });

Â  Â  // --- Login/Otentikasi ---
Â  Â  function toggleLoginFields() {
Â  Â  Â  Â  const level = document.getElementById('accessLevel').value;
Â  Â  Â  Â  document.getElementById('loginNIP').value = '';Â 
Â  Â  Â  Â  document.getElementById('loginPIN').value = '';Â 
Â  Â  }

Â  Â  async function login() {
Â  Â  Â  Â  const level = document.getElementById('accessLevel').value;
Â  Â  Â  Â  const nip = document.getElementById('loginNIP').value.trim();
Â  Â  Â  Â  const pin = document.getElementById('loginPIN').value.trim();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!nip || !pin || pin.length < 6) {
Â  Â  Â  Â  Â  Â  Â alert('NIP harus diisi, dan PIN harus 6 digit.');
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById('loginBtn').textContent = 'Memuat...';

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const url = `${GOOGLE_APP_SCRIPT_URL}?action=LOGIN_USER&level=${level}&nip=${nip}&pin=${pin}`;

Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â  const result = await response.json();

Â  Â  Â  Â  Â  Â  if (result.status === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  currentLevel = level;
Â  Â  Â  Â  Â  Â  Â  Â  currentNIP = nip;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginContainer').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mainApp').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('currentUserInfo').textContent = `Akses sebagai: ${level.toUpperCase()} (NIP: ${nip})`;

Â  Â  Â  Â  Â  Â  Â  Â  populateDateSelectors();Â 
Â  Â  Â  Â  Â  Â  Â  Â  checkAccess(level);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Ambil data absensi untuk NIP tersebut/semua data (Admin)
Â  Â  Â  Â  Â  Â  Â  Â  fetchAndLoadData(level, nip);

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert(result.message || 'NIP atau PIN salah. Periksa NIP, PIN, dan Level Akses.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Error saat login:', error);
Â  Â  Â  Â  Â  Â  alert('Gagal terhubung ke Apps Script API. Cek URL dan Deployment.');
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â document.getElementById('loginBtn').textContent = 'Masuk';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function logout() {
Â  Â  Â  Â  currentLevel = 'user';
Â  Â  Â  Â  currentNIP = null;
Â  Â  Â  Â  document.getElementById('mainApp').style.display = 'none';
Â  Â  Â  Â  document.getElementById('loginContainer').style.display = 'block';
Â  Â  Â  Â  document.querySelector('#dataTable tbody').innerHTML = '';
Â  Â  Â  Â  document.getElementById('loginNIP').value = '';
Â  Â  Â  Â  document.getElementById('loginPIN').value = '';
Â  Â  Â  Â  toggleLoginFields();
Â  Â  Â  Â  displayInputResults();
Â  Â  }
Â  Â Â 
Â  Â  // --- Data Loading & Table Management ---
Â  Â  async function fetchAndLoadData(level, nip) {
Â  Â  Â  Â  const month = document.getElementById('monthSelect').value;
Â  Â  Â  Â  const year = document.getElementById('yearSelect').value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  let action = level === 'admin' ? 'READ_ALL' : 'READ_USER_ABSENSI';
Â  Â  Â  Â  let url = `${GOOGLE_APP_SCRIPT_URL}?action=${action}&month=${month}&year=${year}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (level === 'user') {
Â  Â  Â  Â  Â  Â  url += `&nip=${nip}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let dataToLoad = [];

Â  Â  Â  Â  Â  Â  if (result.status === 'success' && result.data && result.data.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â dataToLoad = mapAppsScriptDataToObjects(result.data);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  loadDataToTable(dataToLoad);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â console.error('Error fetching absensi data:', error);
Â  Â  Â  Â  Â  Â  Â alert('Gagal mengambil data absensi dari Sheets.');
Â  Â  Â  Â  Â  Â  Â loadDataToTable([]);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function mapAppsScriptDataToObjects(dataArray) {
Â  Â  Â  Â  let objects = [];
Â  Â  Â  Â  // Data array dari Apps Script adalah array 2D yang cocok dengan ABSENSI_MAPPING
Â  Â  Â  Â Â 
Â  Â  Â  Â  dataArray.forEach((row, index) => {
Â  Â  Â  Â  Â  Â  Â let obj = { no: (index + 1).toString() };
Â  Â  Â  Â  Â  Â  Â row.forEach((value, colIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â const fieldName = ABSENSI_MAPPING[colIndex];
Â  Â  Â  Â  Â  Â  Â  Â  Â if (fieldName && fieldName !== 'bulan' && fieldName !== 'tahun' && fieldName !== 'timestamp') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â obj[fieldName] = String(value);
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â });
Â  Â  Â  Â  Â  Â  Â objects.push(obj);
Â  Â  Â  Â  });
Â  Â  Â  Â  return objects;
Â  Â  }


Â  Â  function loadDataToTable(dataArray) {
Â  Â  Â  Â  const tbody = document.querySelector('#dataTable tbody');
Â  Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Jika tidak ada data, buat satu baris kosong (template) untuk input Admin
Â  Â  Â  Â  if (dataArray.length === 0 && currentLevel === 'admin') {
Â  Â  Â  Â  Â  Â  dataArray.push({});
Â  Â  Â  Â  } else if (dataArray.length === 0 && currentLevel === 'user') {
Â  Â  Â  Â  Â  Â  displayInputResults();Â 
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  dataArray.forEach((rowData, index) => {
Â  Â  Â  Â  Â  Â  addRow(rowData, index + 1);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  checkAccess(currentLevel);
Â  Â  Â  Â  document.querySelectorAll('#dataTable tbody input').forEach(input => {
Â  Â  Â  Â  Â  Â  Â input.oninput = function() { updateRowData(this); };
Â  Â  Â  Â  Â  Â  Â if (input.type === 'file') {
Â  Â  Â  Â  Â  Â  Â  Â  input.onchange = function() { updateRowData(this); };
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  });
Â  Â  Â  Â  displayInputResults();
Â  Â  }
Â  Â Â 
Â  Â  function addRow(dataObject = {}, rowIndex) {
Â  Â  Â  Â  const tbody = document.querySelector('#dataTable tbody');
Â  Â  Â  Â  const newRow = document.createElement('tr');
Â  Â  Â  Â  newRow.classList.add('data-row');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const fields = [
Â  Â  Â  Â  Â  Â  'no', 'nama', 'nip', 'jabatan', 'peringkat', 'harga_jabatan',Â 
Â  Â  Â  Â  Â  Â  'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir',Â 
Â  Â  Â  Â  Â  Â  'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk',Â 
Â  Â  Â  Â  Â  Â  'wk', 'tl', 'psw', 'total_kjk', 'dokumen_pendukung'
Â  Â  Â  Â  ];

Â  Â  Â  Â  fields.forEach(field => {
Â  Â  Â  Â  Â  Â  const td = document.createElement('td');
Â  Â  Â  Â  Â  Â  let input;

Â  Â  Â  Â  Â  Â  if (field === 'dokumen_pendukung') {
Â  Â  Â  Â  Â  Â  Â  Â  input = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'file';
Â  Â  Â  Â  Â  Â  Â  Â  input.name = field;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  input = document.createElement('input');
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'text';
Â  Â  Â  Â  Â  Â  Â  Â  input.name = field;
Â  Â  Â  Â  Â  Â  Â  Â  input.value = field === 'no' ? (rowIndex || tbody.children.length + 1).toString() : (dataObject[field] !== undefined ? dataObject[field] : '');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (field === 'no') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.readOnly = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Isi NIP otomatis untuk User pada baris kosong
Â  Â  Â  Â  Â  Â  Â  Â  if (field === 'nip' && currentLevel === 'user' && !dataObject[field]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â input.value = currentNIP;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â input.readOnly = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  td.appendChild(input);
Â  Â  Â  Â  Â  Â  newRow.appendChild(td);
Â  Â  Â  Â  });

Â  Â  Â  Â  tbody.appendChild(newRow);
Â  Â  }

Â  Â  // --- Access Control & Context ---
Â  Â  function checkAccess(level) {
Â  Â  Â  Â  const isUser = level === 'user';
Â  Â  Â  Â  const tbody = document.querySelector('#dataTable tbody');
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('search').placeholder = isUser ? 'ğŸ” Cari Nama atau NIP Anda...' : 'ğŸ” Cari Nama, NIP, atau Jabatan...';

Â  Â  Â  Â  document.getElementById('addRowBtn').style.display = isUser ? 'none' : 'inline-block';
Â  Â  Â  Â  document.getElementById('saveBtn').style.display = isUser ? 'none' : 'inline-block';
Â  Â  Â  Â Â 
Â  Â  Â  Â  tbody.classList.toggle('user-readonly', isUser);
Â  Â  Â  Â Â 
Â  Â  Â  Â  tbody.querySelectorAll('input').forEach(input => {
Â  Â  Â  Â  Â  Â  if (input.name !== 'no') {
Â  Â  Â  Â  Â  Â  Â  Â  input.readOnly = isUser;Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (input.type === 'file') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â input.disabled = isUser;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  document.querySelectorAll('#dataTable th[data-column="dokumen_pendukung"], #dataTable td:last-child').forEach(el => {
Â  Â  Â  Â  Â  Â  el.style.display = isUser ? 'none' : '';
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function populateDateSelectors() {
Â  Â  Â  Â  const monthSelect = document.getElementById('monthSelect');
Â  Â  Â  Â  const yearSelect = document.getElementById('yearSelect');
Â  Â  Â  Â  monthSelect.innerHTML = '';
Â  Â  Â  Â  yearSelect.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  const currentMonth = now.getMonth();Â 
Â  Â  Â  Â  const currentYear = now.getFullYear();

Â  Â  Â  Â  const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

Â  Â  Â  Â  months.forEach((month, index) => {
Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = index + 1;
Â  Â  Â  Â  Â  Â  option.textContent = month;
Â  Â  Â  Â  Â  Â  if (index === currentMonth) { option.selected = true; }
Â  Â  Â  Â  Â  Â  monthSelect.appendChild(option);
Â  Â  Â  Â  });

Â  Â  Â  Â  for (let year = currentYear - 5; year <= currentYear + 5; year++) {
Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = year;
Â  Â  Â  Â  Â  Â  option.textContent = year;
Â  Â  Â  Â  Â  Â  if (year === currentYear) { option.selected = true; }
Â  Â  Â  Â  Â  Â  yearSelect.appendChild(option);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  monthSelect.addEventListener('change', updateTableContext);
Â  Â  Â  Â  yearSelect.addEventListener('change', updateTableContext);
Â  Â  Â  Â Â 
Â  Â  Â  Â  updateTableContext();Â 
Â  Â  }

Â  Â  function updateTableContext() {
Â  Â  Â  Â  const monthSelect = document.getElementById('monthSelect');
Â  Â  Â  Â  const yearSelect = document.getElementById('yearSelect');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!monthSelect || !yearSelect) return;Â 

Â  Â  Â  Â  const monthText = monthSelect.options[monthSelect.selectedIndex].text;
Â  Â  Â  Â  const year = yearSelect.value;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const hasilH3 = document.querySelector('#hasilInputContainer h3');
Â  Â  Â  Â  if (hasilH3) {
Â  Â  Â  Â  Â  Â  hasilH3.textContent = `ğŸ“‘ Tampilan Hasil Input Data Bulan ${monthText} Tahun ${year}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (currentNIP) {
Â  Â  Â  Â  Â  Â  Â fetchAndLoadData(currentLevel, currentNIP);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- Data Collection & Submission ---
Â  Â  document.getElementById('addRowBtn').addEventListener('click', function() {
Â  Â  Â  Â  if (currentLevel !== 'admin') { alert('Akses ditolak.'); return; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const tbody = document.querySelector('#dataTable tbody');
Â  Â  Â  Â  addRow({});
Â  Â  Â  Â Â 
Â  Â  Â  Â  const newRow = tbody.lastElementChild;
Â  Â  Â  Â  newRow.querySelectorAll('input').forEach(i => {
Â  Â  Â  Â  Â  Â  i.oninput = function() { updateRowData(this); };
Â  Â  Â  Â  Â  Â  Â if (i.type === 'file') {
Â  Â  Â  Â  Â  Â  Â  Â  i.onchange = function() { updateRowData(this); };
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  });

Â  Â  Â  Â  newRow.querySelector('input[name="nama"]').focus();
Â  Â  Â  Â  displayInputResults();
Â  Â  });

Â  Â  function collectDataForSheet() {
Â  Â  Â  const rows = document.querySelectorAll('#dataTable tbody tr');
Â  Â  Â  let data = [];
Â  Â  Â  const month = document.getElementById('monthSelect').value;
Â  Â  Â  const year = document.getElementById('yearSelect').value;
Â  Â  Â  
Â  Â  Â  // Mendefinisikan ulang fields untuk memastikan urutan data yang dikumpulkan (tanpa 'no')
Â  Â  Â  const dataFields = [
Â  Â  Â  Â  Â  'nip', 'nama', 'jabatan', 'peringkat', 'harga_jabatan',Â 
Â  Â  Â  Â  Â  'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir',Â 
Â  Â  Â  Â  Â  'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk',Â 
Â  Â  Â  Â  Â  'wk', 'tl', 'psw', 'total_kjk', 'dokumen_pendukung'
Â  Â  Â  ];


Â  Â  Â  rows.forEach(row => {
Â  Â  Â  Â  // Hanya kumpulkan baris yang terlihat dan memiliki NIP
Â  Â  Â  Â  if (row.style.display === 'none') return;
Â  Â  Â  Â  const nipInput = row.querySelector('input[name="nip"]');
Â  Â  Â  Â  if (!nipInput || !nipInput.value) return;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  let record = {};
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Isi data sesuai urutan ABSENSI_MAPPING (termasuk kolom tersembunyi seperti bulan, tahun, timestamp)
Â  Â  Â  Â  ABSENSI_MAPPING.forEach(field => {
Â  Â  Â  Â  Â  Â  if (field === 'bulan') {
Â  Â  Â  Â  Â  Â  Â  Â  Â record[field] = month;
Â  Â  Â  Â  Â  Â  } else if (field === 'tahun') {
Â  Â  Â  Â  Â  Â  Â  Â  Â record[field] = year;
Â  Â  Â  Â  Â  Â  } else if (field === 'timestamp') {
Â  Â  Â  Â  Â  Â  Â  Â  Â record[field] = new Date().toLocaleString(); // Format waktu lokal
Â  Â  Â  Â  Â  Â  } else if (field === 'dokumen_pendukung') {
Â  Â  Â  Â  Â  Â  Â  Â  const input = row.querySelector(`input[name="${field}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  // Karena kita tidak benar-benar mengunggah file di sini, kita hanya simpan namanya (jika ada)
Â  Â  Â  Â  Â  Â  Â  Â  // Jika ini adalah baris data yang sudah dimuat, nilainya mungkin berupa URL/Nama File lama
Â  Â  Â  Â  Â  Â  Â  Â  record[field] = input?.files[0]?.name || input?.value || ''; 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â const input = row.querySelector(`input[name="${field}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  Â if (input) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  record[field] = input.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  data.push(record);
Â  Â  Â  });
Â  Â  Â  return data;
Â  Â  }
Â  Â Â 
Â  Â  document.getElementById('saveBtn').addEventListener('click', async function() {
Â  Â  Â  Â  if (currentLevel !== 'admin') {Â 
Â  Â  Â  Â  Â  Â  Â alert('Akses ditolak. Hanya Admin yang dapat menyimpan data.');Â 
Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const dataToSave = collectDataForSheet();
Â  Â  Â  Â  if (dataToSave.length === 0) {
Â  Â  Â  Â  Â  Â  alert('Tidak ada data absensi untuk disimpan.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  document.getElementById('saveBtn').textContent = 'Menyimpan...';
Â  Â  Â  Â  Â  Â  // Catatan: Apps Script harus memproses array data ini.
Â  Â  Â  Â  Â  Â  const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ "action": "SAVE_ABSENSI", records: dataToSave })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (result.status === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Data berhasil disimpan ke Google Sheets!');
Â  Â  Â  Â  Â  Â  Â  Â  // Muat ulang data untuk melihat data yang baru disimpan
Â  Â  Â  Â  Â  Â  Â  Â  fetchAndLoadData(currentLevel, currentNIP);Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Gagal menyimpan data: ${result.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â console.error('Error saat menyimpan data:', error);
Â  Â  Â  Â  Â  Â  Â alert('Gagal mengirim data ke Apps Script API.');
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â document.getElementById('saveBtn').textContent = 'ğŸ’¾ Simpan Data & Tampilkan Hasil';
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // -------------------------------------------------------------------
Â  Â  // â­ LOGIKA TAMBAHAN (Display dan Export)
Â  Â  // -------------------------------------------------------------------

Â  Â  // Helper: Memastikan displayResults dipanggil saat ada perubahan input
Â  Â  function updateRowData(element) { displayInputResults(); }
Â  Â  
Â  Â  function displayInputResults() {
Â  Â  Â  Â  const container = document.getElementById('hasilInputContainer');
Â  Â  Â  Â  // Hanya kumpulkan data yang ditampilkan (tidak semua data dari Sheets)
Â  Â  Â  Â  const data = collectDataForSheet(); 
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Kosongkan konten lama kecuali H3
Â  Â  Â  Â  let content = document.createElement('div');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (data.length === 0) {
Â  Â  Â  Â  Â  Â  content.innerHTML = '<p style="color: #ef4444; font-weight: bold;">Tidak ada data absensi untuk periode ini yang sedang ditampilkan/diinputkan.</p>';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  let html = `<p style="font-size: 1.1em; margin-bottom: 10px;">Total **${data.length}** data Pegawai yang ditampilkan:</p>`;
Â  Â  Â  Â  Â  Â  html += '<ul style="list-style: disc; margin-left: 20px;">';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Tampilkan 5 data teratas saja
Â  Â  Â  Â  Â  Â  data.slice(0, 5).forEach((record, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  // Gunakan field yang relevan untuk ringkasan
Â  Â  Â  Â  Â  Â  Â  Â  html += `<li>**${record.nama || '[Nama Kosong]'}** (NIP: ${record.nip || 'NIP Kosong'}) - Masuk: ${record.masuk || 0}, Telat: ${record.telat || 0}, Cuti: ${record.cuti || 0}</li>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (data.length > 5) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<li>... dan ${data.length - 5} data lainnya.</li>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  html += '</ul>';
Â  Â  Â  Â  Â  Â  content.innerHTML = html;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ganti konten di dalam container, pertahankan H3
Â  Â  Â  Â  while (container.children.length > 1) {
Â  Â  Â  Â  Â  Â  container.removeChild(container.lastChild);
Â  Â  Â  Â  }
Â  Â  Â  Â  container.appendChild(content);
Â  Â  }
Â  Â Â 
Â  Â  function exportTo(type) {
Â  Â  Â  Â  const data = collectDataForSheet();
Â  Â  Â  Â  if (data.length === 0) {
Â  Â  Â  Â  Â  Â  alert('Tidak ada data untuk diekspor.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const monthText = document.getElementById('monthSelect').options[document.getElementById('monthSelect').selectedIndex].text;
Â  Â  Â  Â  const year = document.getElementById('yearSelect').value;
Â  Â  Â  Â  const extension = type === 'CSV' ? 'csv' : 'xls';
Â  Â  Â  Â  const fileName = `Absensi_${monthText}_${year}_${type}.${extension}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. Ambil Header dari Tabel (kecuali Dokumen Pendukung)
Â  Â  Â  Â  const headers = Array.from(document.querySelectorAll('#dataTable thead th[data-column]'))
Â  Â  Â  Â  Â  Â  .filter(th => th.getAttribute('data-column') !== 'dokumen_pendukung')
Â  Â  Â  Â  Â  Â  .map(th => th.textContent.trim());

Â  Â  Â  Â  // 2. Tentukan urutan kunci data yang akan diekspor (sesuai header)
Â  Â  Â  Â  const dataKeys = Array.from(document.querySelectorAll('#dataTable thead th[data-column]'))
Â  Â  Â  Â  Â  Â  .filter(th => th.getAttribute('data-column') !== 'dokumen_pendukung')
Â  Â  Â  Â  Â  Â  .map(th => th.getAttribute('data-column'));

Â  Â  Â  Â  // 3. Susun data menjadi string CSV
Â  Â  Â  Â  const csvRows = data.map(rowObj => {
Â  Â  Â  Â  Â  Â  // Ambil nilai dari objek data (hasil collectDataForSheet) sesuai urutan dataKeys
Â  Â  Â  Â  Â  Â  const rowValues = dataKeys.map(key => {
Â  Â  Â  Â  Â  Â  Â  Â  const value = String(rowObj[key] || '');
Â  Â  Â  Â  Â  Â  Â  Â  // Escape quotes dan wrap dalam quotes
Â  Â  Â  Â  Â  Â  Â  Â  return `"${value.replace(/"/g, '""')}"`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return rowValues.join(',');
Â  Â  Â  Â  });

Â  Â  Â  Â  let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + // \uFEFF untuk BOM (Mendukung Excel UTF-8)
Â  Â  Â  Â  Â  Â  headers.map(h => `"${h}"`).join(',') + "\n" +
Â  Â  Â  Â  Â  Â  csvRows.join('\n');

Â  Â  Â  Â  const encodedUri = encodeURI(csvContent);
Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  link.setAttribute("href", encodedUri);
Â  Â  Â  Â  link.setAttribute("download", fileName);
Â  Â  Â  Â  document.body.appendChild(link);Â 
Â  Â  Â  Â  link.click();
Â  Â  Â  Â  document.body.removeChild(link);
Â  Â  }

Â  Â  function exportCSV() { exportTo('CSV'); }
Â  Â  function exportExcel() { exportTo('Excel'); }
Â  Â Â 
Â  Â  // --- Sorting Logic (dipertahankan) ---
Â  Â  const headers = document.querySelectorAll('#dataTable thead th[data-column]');
Â  Â  let sortColumn = null;
Â  Â  let sortDirection = 'asc';

Â  Â  headers.forEach(header => {
Â  Â  Â  Â  header.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  const column = this.getAttribute('data-column');
Â  Â  Â  Â  Â  Â  if (sortColumn === column) {
Â  Â  Â  Â  Â  Â  Â  Â  sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  sortColumn = column;
Â  Â  Â  Â  Â  Â  Â  Â  sortDirection = 'asc';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  headers.forEach(h => { h.classList.remove('sort-asc', 'sort-desc'); });
Â  Â  Â  Â  Â  Â  this.classList.add('sort-' + sortDirection);

Â  Â  Â  Â  Â  Â  sortData(column, sortDirection);
Â  Â  Â  Â  Â  Â  displayInputResults();
Â  Â  Â  Â  });
Â  Â  });

Â  Â  function sortData(column, direction) {
Â  Â  Â  Â  const tbody = document.querySelector('#dataTable tbody');
Â  Â  Â  Â  const rows = Array.from(tbody.querySelectorAll('tr'));
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sortedRows = rows.sort((a, b) => {
Â  Â  Â  Â  Â  Â  let aValue, bValue;
Â  Â  Â  Â  Â  Â  const aInput = a.querySelector(`input[name="${column}"]`);
Â  Â  Â  Â  Â  Â  const bInput = b.querySelector(`input[name="${column}"]`);

Â  Â  Â  Â  Â  Â  if (aInput && bInput) {
Â  Â  Â  Â  Â  Â  Â  Â  const numericFields = ['no', 'harga_jabatan', 'nilai_pres_kerja', 'masuk', 'telat', 'sakit', 'izin', 'tidak_hadir', 'dinas', 'tugas_luar', 'tugas_belajar', 'cuti', 'libur', 'jumlah_hk', 'wk', 'tl', 'psw', 'total_kjk'];
Â  Â  Â  Â  Â  Â  Â  Â  if (numericFields.includes(column)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aValue = Number(aInput.value.replace(/[^0-9\.]/g, '')) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bValue = Number(bInput.value.replace(/[^0-9\.]/g, '')) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aValue = aInput.value.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bValue = bInput.value.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else { return 0; }

Â  Â  Â  Â  Â  Â  let comparison = 0;
Â  Â  Â  Â  Â  Â  if (aValue > bValue) { comparison = 1; } else if (aValue < bValue) { comparison = -1; }

Â  Â  Â  Â  Â  Â  return direction === 'asc' ? comparison : comparison * -1;
Â  Â  Â  Â  });

Â  Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  Â  sortedRows.forEach(row => tbody.appendChild(row));
Â  Â  }
Â  Â Â 
Â  Â  // --- Filtering Logic (dipertahankan) ---
Â  Â  document.getElementById('search').addEventListener('keyup', function() {
Â  Â  Â  Â  const filter = this.value.toUpperCase();
Â  Â  Â  Â  const rows = document.querySelectorAll('#dataTable tbody tr');

Â  Â  Â  Â  rows.forEach(row => {
Â  Â  Â  Â  Â  Â  const nama = row.querySelector('input[name="nama"]')?.value.toUpperCase() || '';
Â  Â  Â  Â  Â  Â  const nip = row.querySelector('input[name="nip"]')?.value.toUpperCase() || '';
Â  Â  Â  Â  Â  Â  const jabatan = row.querySelector('input[name="jabatan"]')?.value.toUpperCase() || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let isVisible = false;

Â  Â  Â  Â  Â  Â  if (currentLevel === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  if (nama.includes(filter) || nip.includes(filter) || jabatan.includes(filter)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isVisible = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (currentLevel === 'user' && nip === currentNIP) {
Â  Â  Â  Â  Â  Â  Â  Â  // User hanya melihat data yang NIPnya cocok dengan NIP login
Â  Â  Â  Â  Â  Â  Â  Â  if (nip === currentNIP.toUpperCase() && (nama.includes(filter) || nip.includes(filter))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isVisible = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  row.style.display = isVisible ? '' : 'none';
Â  Â  Â  Â  });
Â  Â  Â  Â  displayInputResults();Â 
Â  Â  });
</script>

</body>
</html>
